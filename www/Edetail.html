<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="description" content="Ayam Penyet Best Salary Management System">
    <meta name="theme-color" content="#ffcc09">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <title>MyGaji â€” Employee Details</title>
    <link rel="icon" href="src/APB.png">
    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="css/css/all.min.css">
    <!-- Bootstrap 5 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <!-- AdminLTE -->
    <link rel="stylesheet" href="css/adminlte.min.css">

    <style>
    :root {
      --primary: rgb(255, 204, 9);
      --secondary: #808097;
      --accent: #8bc53f;
      --highlight: #2f5e2c;
      --danger: #d1121f;
      --soft: #f5a391;
      --light: #f5f6f9;
      --dark: #212529;
      --card-shadow: 0 3px 8px rgba(0,0,0,0.08);
      --transition-speed: 0.3s;
    }

    body, html {
      font-family: 'Poppins', sans-serif;
      background-color: var(--light);
      color: var(--dark);
      overflow-x: hidden;
      margin: 0;
      padding: 0;
    }

    .btn-print {
      background-color: var(--primary);
      color: var(--dark);
      border: none;
      border-radius: 50px;
      padding: 10px 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .btn-print:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    </style>

  </head>
  <body class="hold-transition layout-top-nav">
  
  <div class="wrapper">
  
    <!-- Header with back arrow -->
    <nav class="main-header navbar navbar-expand navbar-white border-0">
      <div class="container" style="display: flex; justify-content: center; align-items: center;">
        <!-- <span class="mx-auto font-weight-bold h5 mb-0">Employee Details</span> -->
        <img src="src/APB.png" alt="Logo" style="height: 90px; width: auto; object-fit: contain;">
      </div>
    </nav>
    
    <div class="container mt-3 mb-2 d-flex justify-content-between align-items-center">
      <button class="btn-print" onclick="location.href='StaffList.html'">
        <i class="fas fa-arrow-left fa-lg text-dark"></i>
      </button>
      <button class="btn-print">Print Paycheck</button>
    </div>
    <!-- Content -->
    <div class="content px-3 mt-3">
      <!-- Profile Card -->
      <div class="card mb-4 p-3 text-center">
        <img id="profile-preview" src="src/me.jpg" alt="Profile" class="rounded-circle mx-auto mb-3" style="width: 120px; height: 120px; object-fit: cover;">
        <div class="mt-2">
          <input type="file" id="profile-input" accept="image/*" class="form-control-file">
          <button onclick="uploadProfileImage()" class="btn btn-sm btn-success mt-2">Upload</button>
        </div>
        <h5 class="mt-3" id="employee-name"><strong></strong></h5>
      </div>
  
      <!-- Personal Info Card -->
      <div class="card mb-4 p-3" style="border-radius: 12px;">
        <h6 class="text-success"><i class="fas fa-user mr-1"></i> Personal Information</h6>
        <p><strong>Employee ID:</strong> <span id="employee-id">-</span></p>
        <p><strong>IC Number:</strong> <span id="employee-ic">-</span></p>
        <p><strong>Address:</strong> <span id="employee-address">-</span></p>
        <p><strong>Email:</strong> <span id="employee-email">-</span></p>
        <p><strong>Phone Number:</strong> <span id="employee-phoneNo">-</span></p>
        <p><strong>Medical Issues:</strong> <span id="employee-disease">-</span></p>
      </div>
  
      <!-- Financial Info Card -->
      <div class="card mb-4 p-3" style="border-radius: 12px;">
        <h6 class="text-warning"><i class="fas fa-credit-card mr-1"></i> Financial Information</h6>
        <p><strong>KWSP:</strong> <span id="employee-kwsp">-</span></p>
        <p><strong>Bank Name:</strong> <span id="employee-bank">-</span></p>
        <p><strong>Bank Number:</strong> <span id="employee-bankNo">-</span></p>
      </div>
  
      <!-- Family Info Card -->
      <div class="card mb-5 p-3" style="border-radius: 12px;">
        <h6 class="text-info"><i class="fas fa-home mr-1"></i> Family Details</h6>
        <p><strong>Household Name:</strong> <span id="employee-Hname">-</span></p>
        <p><strong>Number of Kids:</strong> <span id="employee-Hkids">-</span></p>
        <p><strong>Household Phone:</strong> <span id="employee-HphoneNo">-</span></p>
        <p><strong>Next of Kin:</strong> <span id="employee-Fname">-</span></p>
        <p><strong>KIN Phone:</strong> <span id="employee-FphoneNo">-</span></p>
  
      </div>
      <div class="d-flex justify-content-between mt-3" style="border-radius: 12px;">
        <button id="delete-staff-btn" class="btn btn-danger flex-fill mr-2" style="border-radius: 50px;">Delete</button>
        <button id="update-staff-btn" class="btn btn-success flex-fill ml-2" style="border-radius: 50px;">Update</button>
      </div>
    </div>
  
    <!-- Bottom Tab Bar -->
    <div class="fixed-bottom bg-light shadow-sm">
      <div class="d-flex justify-content-around py-2">
        <a href="home.html" class="text-center text-muted"><i class="fas fa-home fa-lg"></i><br>Home</a>
        <a href="staffList.html" class="text-center text-muted"><i class="fas fa-users fa-lg"></i><br>Staff</a>
        <a href="salary.html" class="text-center text-muted"><i class="fas fa-money-bill-wave fa-lg"></i><br>Salary</a>
        <a href="profile.html" class="text-center text-muted"><i class="fas fa-user-circle fa-lg"></i><br>Profile</a>
      </div>
    </div>
  
  </div>

<!-- REQUIRED SCRIPTS -->

<!-- jQuery -->
<script src="jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- AdminLTE App -->
<script src="js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="js/demo.js"></script>

<!-- Import Firebase setup from calculation.js -->
<script type="module">
    import { db, app } from './calculation.js';
    import { doc, getDoc, deleteDoc, collection, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    const auth = getAuth();
    const storage = getStorage(app);

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        // User not logged in
        location.href = 'login.html';
        return;
      }
    
      const loginTime = parseInt(localStorage.getItem('loginTime'), 10);
      const currentTime = Date.now();
      const sessionDuration = 30 * 60 * 1000; // 30 minutes in milliseconds
    
      if (!loginTime || currentTime - loginTime > sessionDuration) {
        // Session expired
        localStorage.removeItem('loginTime');
        signOut(auth).then(() => {
          //alert("Session expired. Please log in again.");
          location.href = 'login.html';
        });
      }
    });

    // USER ACTIVITY DETECTION TO REFRESH SESSION
    function refreshSessionTimer() {
      localStorage.setItem('loginTime', Date.now().toString());
    }

    window.addEventListener('mousemove', refreshSessionTimer);
    window.addEventListener('keydown', refreshSessionTimer);
    window.addEventListener('click', refreshSessionTimer);
    
    // Function to get query parameter by name
    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }
  
    // Fetch employee details and display them
    async function fetchEmployeeDetails() {
      const employeeId = getQueryParam('id');
      console.log("Employee ID from URL:", employeeId); // Debugging output
  
      if (employeeId) {
        try {
          // Fetch the document directly using the employeeId
          const employeeDoc = await getDoc(doc(db, 'employees', employeeId));

          if (employeeDoc.exists()) {
            const employeeData = employeeDoc.data();
            //console.log("Fetched Employee Data:", employeeData); // Debugging output

            // Populate the fields with the fetched data
            document.getElementById('employee-id').innerText = employeeData.id || employeeDoc.id; // Use Firestore document ID as fallback
            document.getElementById('employee-name').innerText = employeeData.Nama || '';
            document.getElementById('employee-address').innerText = employeeData.Address || '';
            document.getElementById('employee-email').innerText = employeeData.Email || '';
            document.getElementById('employee-ic').innerText = employeeData.IC || '';
            document.getElementById('employee-kwsp').innerText = employeeData.KWSP || '';
            document.getElementById('employee-bank').innerText = employeeData.Bank || '';
            document.getElementById('employee-bankNo').innerText = employeeData.Nombor_Bank || '';
            document.getElementById('employee-phoneNo').innerText = employeeData.Phone_Number || '';

            // Family Related
            document.getElementById('employee-Hname').innerText = employeeData.Nama_Suami_Istri || '';
            document.getElementById('employee-Hkids').innerText = employeeData.Bilangan_Anak || '';
            document.getElementById('employee-HphoneNo').innerText = employeeData.Nombor_Telefon_Suami_Istri || '';
            document.getElementById('employee-Fname').innerText = employeeData.Nama_Pewaris_Ibu_Ayah || '';
            document.getElementById('employee-FphoneNo').innerText = employeeData.Nombor_Telefon_Pewaris_Ibu_Ayah || '';

            const disease = employeeData["Penyakit"] || 'None';
            document.getElementById('employee-disease').innerText = disease;

            // Check if there is a profileImage URL and update the profile preview
            if (employeeData.profileImage) {
              document.getElementById("profile-preview").src = employeeData.profileImage;
            }

          } else {
            console.log("No such document exists in Firestore!");
          }
        } catch (error) {
          console.error("Error fetching document:", error);
        }
      } else {
        console.log("No employee ID provided in the URL.");
      }
    }

    // Function to delete employee details
    async function deleteEmployee() {
      const employeeId = getQueryParam('id');
      if (employeeId) {
        try {
          // Fetch employee data
          const employeeDoc = await getDoc(doc(db, 'employees', employeeId));
          const employeeData = employeeDoc.data();

          // Delete related salaries
          const salariesQuery = await getDocs(query(collection(db, 'salaries'), where('employeeId', '==', employeeData.id)));
          const deletePromises = salariesQuery.docs.map((doc) => deleteDoc(doc.ref));
          await Promise.all(deletePromises);
          console.log('Related salaries deleted successfully!');

          // Delete the employee document
          const employeeRef = doc(db, 'employees', employeeId);
          await deleteDoc(employeeRef);

          alert('Employee record and related salaries deleted successfully!');
          window.location.href = 'StaffList.html'; // Redirect to another page after deletion
        } catch (error) {
          console.error('Error deleting documents:', error);
          alert('Failed to delete employee record and related salaries.');
        }
      } else {
        alert('No employee ID provided in the URL.');
      }
    }

    // Attach event listener to the delete button
    document.getElementById('delete-staff-btn').addEventListener('click', () => {
      if (confirm('Are you sure you want to delete this employee?')) {
        deleteEmployee();
      }
    });

    // Attach event listener to the update button
    document.getElementById('update-staff-btn').addEventListener('click', () => {
      const employeeId = getQueryParam('id');
      if (employeeId) {
        window.location.href = `update_Edetail.html?id=${employeeId}`; // Redirect to update page with employee ID
      } else {
        alert('No employee ID provided in the URL.');
      }
    });

    window.uploadProfileImage = async function () {
  const file = document.getElementById("profile-input").files[0];
  const employeeId = getQueryParam('id');

  if (!file || !employeeId) {
    alert("No file selected or employee ID missing.");
    return;
  }

  // Create a new image element
  const img = new Image();
  
  // Create a file reader to read the uploaded file
  const reader = new FileReader();
  
  reader.onload = function(e) {
    img.src = e.target.result; // Set the image source to the file content
    
    img.onload = function() {
      // Resize the image and compress it directly using a canvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      const maxWidth = 800; // Max width (resize limit)
      const maxHeight = 800; // Max height (resize limit)
      let width = img.width;
      let height = img.height;

      // Resize the image to fit within max dimensions
      if (width > height) {
        if (width > maxWidth) {
          height = height * maxWidth / width;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = width * maxHeight / height;
          height = maxHeight;
        }
      }

      // Set canvas size and draw the image
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);

      // Compress and upload the image
      canvas.toBlob(async function(blob) {
        if (blob.size > 1024 * 1024) {
          alert("Image is too large. Please select a smaller image.");
          return;
        }

        // Upload to Firebase Storage
        const storageRef = ref(storage, `profile_photos/${employeeId}.jpg`);
        try {
          await uploadBytes(storageRef, blob);
          const downloadURL = await getDownloadURL(storageRef);

          // Update Firestore with the image URL
          const employeeRef = doc(db, 'employees', employeeId);
          await updateDoc(employeeRef, { profileImage: downloadURL });

          // Update the image preview
          document.getElementById("profile-preview").src = downloadURL;
          alert("Profile picture updated!");
        } catch (error) {
          console.error("Error uploading image:", error);
          alert("Failed to upload image.");
        }
      }, 'image/jpeg', 0.8); // 80% quality for JPEG
    };
  };

  // Trigger the file reader to load the image
  reader.readAsDataURL(file);
};

  
    fetchEmployeeDetails();
  </script>
  

</body>
</html>
